# /etc/logstash/conf.d/01-freeradius-pipeline.conf
input {
  beats {
    port => 5044
  }
  tcp {
    port => 5045
    codec => json
  }
}

filter {
  # Aplica o filtro apenas se o log for do tipo 'freeradius' (definido no filebeat)
  if [log_type] == "freeradius" {
    # Exemplo de 'grok' para um log de autenticação bem-sucedida.
    # Você PRECISA adaptar este padrão para o formato exato do seu log.
    grok {
      match => { "message" => "Auth: Login OK: \[%{USER:user.name}\] \(from client %{WORD:radius.client.name} port %{NUMBER:radius.nas_port} cli %{MAC:client.mac.address}\)" }
      # Adicione outros padrões 'match' para diferentes tipos de logs (falha, etc.)
    }

    # Se o log contém o IP do cliente (Framed-IP-Address), extraia-o
    if [message] =~ /Framed-IP-Address/ {
        grok {
            match => { "message" => "Framed-IP-Address = %{IP:client.ip}" }
        }
    }
    
    # Remove o campo original da mensagem se o 'grok' teve sucesso
    if "_grokparsefailure" not in [tags] {
      mutate {
        remove_field => ["message"]
      }
    }
  }
}

output {
  stdout {
    codec => "rubydebug"
  }
  if [fields][log_type] == "freeradius" {
    elasticsearch {
      hosts => ["http://172.16.0.20:9200"] # Endereço do seu Elasticsearch
      index => "freeradius-auth-%{+YYYY.MM.dd}" # Cria um índice diário para os logs
    }
  }
}
